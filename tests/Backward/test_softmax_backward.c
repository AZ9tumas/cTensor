#include "../../include/cten.h"
#include "../test_utils.h"
#include "../csv_reporter.h"
#include "../test_config.h"
#include <stdio.h>

void test_softmax_backward() {
    const char* op_name = "softmax_backward";
    PoolId pool_id = 0; 
    cten_begin_malloc(pool_id);

    // Test Case 1
    {
        const char* tc_name = "Simple_softmax_backward";
        TensorShape shape_1 = { 6, 0, 0, 0 };
        int dim_1 = 0;
        float softmax_output_data_1[] = {
            0.491293f, 0.290196f, 0.099553f, 0.041380f, 0.034337f, 0.043241f
        };
        float upstream_grad_data_1[] = {
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f
        };
        float expected_grad_1[] = {
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f
        };
        Tensor t_softmax_output_1 = create_test_tensor(shape_1, softmax_output_data_1, false);
        Tensor t_upstream_grad_1 = create_test_tensor(shape_1, upstream_grad_data_1, false);
        Tensor t_expected_grad_1 = create_test_tensor(shape_1, expected_grad_1, false);
        Tensor t_softmax_1 = nn_softmax(t_softmax_output_1, dim_1);
        Tensor_backward(t_softmax_1, t_upstream_grad_1);
        compare_tensors(&t_softmax_1.node->grad, &t_expected_grad_1, op_name, tc_name, 1, TEST_FLOAT_TOLERANCE);
    }

	// Test Case 2
	{
	    const char* tc_name = "softmax_backward_2d_dim_0";
        TensorShape shape_2 = { 4, 5, 0, 0 };
        int dim_2 = 0;
        float softmax_output_data_2[] = {
            0.259828f, 0.047797f, 0.277548f, 0.280166f, 0.185578f, 0.131360f, 0.137473f, 0.089268f, 
            0.040785f, 0.266524f, 0.194610f, 0.431466f, 0.113199f, 0.140672f, 0.308902f, 0.414202f, 
            0.383265f, 0.519984f, 0.538377f, 0.238995f
        };
        float upstream_grad_data_2[] = {
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f
        };
        float expected_grad_2[] = {
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f
        };

        Tensor t_softmax_output_2 = create_test_tensor(shape_2, softmax_output_data_2, false);
        Tensor t_upstream_grad_2 = create_test_tensor(shape_2, upstream_grad_data_2, false);
        Tensor t_expected_grad_2 = create_test_tensor(shape_2, expected_grad_2, false);
        Tensor t_softmax_2 = nn_softmax(t_softmax_output_2, dim_2);
        Tensor_backward(t_softmax_2, t_upstream_grad_2);
        compare_tensors(&t_softmax_2.node->grad, &t_expected_grad_2, op_name, tc_name, 1, TEST_FLOAT_TOLERANCE);
    }

	// Test Case 3
	{
	    const char* tc_name = "softmax_backward_2d_dim_1";
        TensorShape shape_3 = { 4, 5, 0, 0 };
        int dim_3 = 1;
        float softmax_output_data_3[] = {
            0.281295f, 0.241706f, 0.252463f, 0.049890f, 0.174646f, 0.172607f, 0.073895f, 0.330703f, 
            0.359079f, 0.063717f, 0.308131f, 0.021912f, 0.235711f, 0.376043f, 0.058204f, 0.071114f, 
            0.383512f, 0.142979f, 0.187754f, 0.214642f
        };
        float upstream_grad_data_3[] = {
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f
        };
        float expected_grad_3[] = {
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f
        };

        Tensor t_softmax_output_3 = create_test_tensor(shape_3, softmax_output_data_3, false);
        Tensor t_upstream_grad_3 = create_test_tensor(shape_3, upstream_grad_data_3, false);
        Tensor t_expected_grad_3 = create_test_tensor(shape_3, expected_grad_3, false);
        Tensor t_softmax_3 = nn_softmax(t_softmax_output_3, dim_3);
        Tensor_backward(t_softmax_3, t_upstream_grad_3);
        compare_tensors(&t_softmax_3.node->grad, &t_expected_grad_3, op_name, tc_name, 1, TEST_FLOAT_TOLERANCE);
    }

	// Test Case 4
    {
        const char* tc_name = "softmax_backward_3d_dim_0";
        TensorShape shape_4 = { 3, 4, 5, 0 };
        int dim_4 = 0;
        float softmax_output_data_4[] = {
		0.300884f, 0.460076f, 0.079808f, 0.188380f, 0.535354f, 0.090242f, 0.294035f, 0.029022f, 
		0.035824f, 0.898965f, 0.096504f, 0.737632f, 0.189031f, 0.509308f, 0.434179f, 0.458033f, 
		0.195747f, 0.209742f, 0.071491f, 0.216761f, 0.584676f, 0.350448f, 0.065936f, 0.223344f, 
		0.361413f, 0.644221f, 0.637309f, 0.854081f, 0.859709f, 0.015247f, 0.299948f, 0.168507f, 
		0.094690f, 0.174303f, 0.254352f, 0.198134f, 0.048436f, 0.084396f, 0.566486f, 0.164950f, 
		0.114440f, 0.189476f, 0.854256f, 0.588275f, 0.103233f, 0.265537f, 0.068656f, 0.116896f, 
		0.104467f, 0.085789f, 0.603549f, 0.093861f, 0.716278f, 0.316389f, 0.311469f, 0.343833f, 
		0.755817f, 0.705862f, 0.362023f, 0.618290f
        };
        float upstream_grad_data_4[] = {
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f
        };
        float expected_grad_4[] = {
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f
        };

        Tensor t_softmax_output_4 = create_test_tensor(shape_4, softmax_output_data_4, false);
        Tensor t_upstream_grad_4 = create_test_tensor(shape_4, upstream_grad_data_4, false);
        Tensor t_expected_grad_4 = create_test_tensor(shape_4, expected_grad_4, false);
        Tensor t_softmax_4 = nn_softmax(t_softmax_output_4, dim_4);
        Tensor_backward(t_softmax_4, t_upstream_grad_4);
        compare_tensors(&t_softmax_4.node->grad, &t_expected_grad_4, op_name, tc_name, 1, TEST_FLOAT_TOLERANCE);
    }

	// Test Case 5
    {
        const char* tc_name = "softmax_backward_3d_dim_1";
        TensorShape shape_5 = { 3, 4, 5, 0 };
        int dim_5 = 1;
        float softmax_output_data_5[] = {
            0.213736f, 0.071841f, 0.493278f, 0.286840f, 0.112850f, 0.434872f, 0.138537f, 0.265375f, 
            0.182145f, 0.133135f, 0.103070f, 0.659365f, 0.101280f, 0.097179f, 0.500021f, 0.248322f, 
            0.130257f, 0.140068f, 0.433836f, 0.253994f, 0.491888f, 0.530057f, 0.069191f, 0.268460f, 
            0.311649f, 0.198072f, 0.174156f, 0.688571f, 0.316698f, 0.235733f, 0.201305f, 0.279905f, 
            0.094012f, 0.241565f, 0.223111f, 0.108736f, 0.015882f, 0.148226f, 0.173276f, 0.229507f, 
            0.111989f, 0.140138f, 0.177901f, 0.145886f, 0.395023f, 0.659009f, 0.336318f, 0.038804f, 
            0.182494f, 0.167875f, 0.200232f, 0.187889f, 0.192922f, 0.349600f, 0.325372f, 0.028770f, 
            0.335654f, 0.590373f, 0.322020f, 0.111729f
        };
        float upstream_grad_data_5[] = {
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f
        };
        float expected_grad_5[] = {
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            -0.000000f, -0.000000f, 0.000000f, 0.000000f, 0.000000f, -0.000000f, -0.000000f, 0.000000f, 
            0.000000f, 0.000000f, -0.000000f, -0.000000f, 0.000000f, 0.000000f, 0.000000f, -0.000000f, 
            -0.000000f, 0.000000f, 0.000000f, 0.000000f
        };

        Tensor t_softmax_output_5 = create_test_tensor(shape_5, softmax_output_data_5, false);
        Tensor t_upstream_grad_5 = create_test_tensor(shape_5, upstream_grad_data_5, false);
        Tensor t_expected_grad_5 = create_test_tensor(shape_5, expected_grad_5, false);
        Tensor t_softmax_5 = nn_softmax(t_softmax_output_5, dim_5);
        Tensor_backward(t_softmax_5, t_upstream_grad_5);
        compare_tensors(&t_softmax_5.node->grad, &t_expected_grad_5, op_name, tc_name, 1, TEST_FLOAT_TOLERANCE);
    }

	// Test Case 6
    {
        const char* tc_name = "softmax_backward_3d_dim_2";
        TensorShape shape_6 = { 3, 4, 5, 0 };
        int dim_6 = 2;
        float softmax_output_data_6[] = {
            0.274572f, 0.327944f, 0.033119f, 0.192682f, 0.171683f, 0.329886f, 0.043537f, 0.133894f, 
            0.428686f, 0.063996f, 0.276949f, 0.062181f, 0.250740f, 0.281050f, 0.129080f, 0.316415f, 
            0.133936f, 0.131813f, 0.277588f, 0.140248f, 0.163021f, 0.158821f, 0.459108f, 0.069788f, 
            0.149263f, 0.025376f, 0.065427f, 0.082601f, 0.661098f, 0.165497f, 0.092270f, 0.146426f, 
            0.070573f, 0.609448f, 0.081284f, 0.203390f, 0.181041f, 0.153127f, 0.200254f, 0.262189f, 
            0.068847f, 0.058354f, 0.542534f, 0.274029f, 0.056236f, 0.212700f, 0.053144f, 0.120847f, 
            0.483704f, 0.129605f, 0.206116f, 0.459948f, 0.105415f, 0.144628f, 0.083892f, 0.379806f, 
            0.127531f, 0.188214f, 0.244900f, 0.059550f
        };
        float upstream_grad_data_6[] = {
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f
        };
        float expected_grad_6[] = {
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f
        };

        Tensor t_softmax_output_6 = create_test_tensor(shape_6, softmax_output_data_6, false);
        Tensor t_upstream_grad_6 = create_test_tensor(shape_6, upstream_grad_data_6, false);
        Tensor t_expected_grad_6 = create_test_tensor(shape_6, expected_grad_6, false);
        Tensor t_softmax_6 = nn_softmax(t_softmax_output_6, dim_6);
        Tensor_backward(t_softmax_6, t_upstream_grad_6);
        compare_tensors(&t_softmax_6.node->grad, &t_expected_grad_6, op_name, tc_name, 1, TEST_FLOAT_TOLERANCE);
    }

	// Test Case 7
    {
        const char* tc_name = "softmax_backward_4d_dim_0";
        TensorShape shape_7 = { 2, 3, 4, 5 };
        int dim_7 = 0;
        float softmax_output_data_7[] = {
            0.569625f, 0.125877f, 0.471346f, 0.500301f, 0.591379f, 0.292845f, 0.130029f, 0.866195f, 
            0.602569f, 0.597063f, 0.841322f, 0.162126f, 0.406428f, 0.866877f, 0.471768f, 0.615089f, 
            0.137583f, 0.670704f, 0.636926f, 0.389366f, 0.384487f, 0.651319f, 0.090905f, 0.821931f, 
            0.172317f, 0.785127f, 0.268635f, 0.526123f, 0.093560f, 0.311492f, 0.276829f, 0.195481f, 
            0.266013f, 0.279443f, 0.762119f, 0.471888f, 0.114459f, 0.624089f, 0.681086f, 0.256820f, 
            0.577499f, 0.522314f, 0.455161f, 0.100279f, 0.845585f, 0.194294f, 0.543203f, 0.569020f, 
            0.474847f, 0.273765f, 0.303435f, 0.703826f, 0.921722f, 0.701926f, 0.449861f, 0.601013f, 
            0.036246f, 0.620161f, 0.322930f, 0.856022f, 0.430375f, 0.874123f, 0.528654f, 0.499700f, 
            0.408621f, 0.707155f, 0.869971f, 0.133805f, 0.397431f, 0.402938f, 0.158678f, 0.837874f, 
            0.593572f, 0.133123f, 0.528232f, 0.384911f, 0.862417f, 0.329296f, 0.363074f, 0.610634f, 
            0.615513f, 0.348681f, 0.909096f, 0.178069f, 0.827683f, 0.214873f, 0.731365f, 0.473877f, 
            0.906440f, 0.688508f, 0.723171f, 0.804519f, 0.733987f, 0.720557f, 0.237881f, 0.528112f, 
            0.885541f, 0.375911f, 0.318914f, 0.743180f, 0.422501f, 0.477685f, 0.544839f, 0.899721f, 
            0.154414f, 0.805706f, 0.456797f, 0.430980f, 0.525153f, 0.726235f, 0.696565f, 0.296174f, 
            0.078278f, 0.298074f, 0.550139f, 0.398987f, 0.963754f, 0.379839f, 0.677070f, 0.143978f
        };
        float upstream_grad_data_7[] = {
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f
        };
        float expected_grad_7[] = {
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, -0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, -0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f
        };

        Tensor t_softmax_output_7 = create_test_tensor(shape_7, softmax_output_data_7, false);
        Tensor t_upstream_grad_7 = create_test_tensor(shape_7, upstream_grad_data_7, false);
        Tensor t_expected_grad_7 = create_test_tensor(shape_7, expected_grad_7, false);
        Tensor t_softmax_7 = nn_softmax(t_softmax_output_7, dim_7);
        Tensor_backward(t_softmax_7, t_upstream_grad_7);
        compare_tensors(&t_softmax_7.node->grad, &t_expected_grad_7, op_name, tc_name, 1, TEST_FLOAT_TOLERANCE);
    }

	// Test Case 8
    {
		const char* tc_name = "softmax_backward_4d_dim_1";
		TensorShape shape_8 = { 2, 3, 4, 5 };
		int dim_8 = 1;
		float softmax_output_data_8[] = {
			0.349329f, 0.468174f, 0.446961f, 0.105402f, 0.353047f, 0.247731f, 0.227469f, 0.284667f, 
			0.345296f, 0.315446f, 0.267886f, 0.386768f, 0.446913f, 0.150942f, 0.266561f, 0.462933f, 
            0.302654f, 0.082296f, 0.472487f, 0.324861f, 0.430109f, 0.470517f, 0.173953f, 0.380958f, 
            0.458720f, 0.374105f, 0.346718f, 0.266339f, 0.318630f, 0.459433f, 0.351063f, 0.358115f, 
            0.157742f, 0.671078f, 0.147977f, 0.020363f, 0.021255f, 0.822086f, 0.452001f, 0.456552f, 
            0.220562f, 0.061309f, 0.379086f, 0.513640f, 0.188233f, 0.378163f, 0.425812f, 0.448994f, 
            0.336075f, 0.225121f, 0.381051f, 0.255117f, 0.395346f, 0.177980f, 0.585462f, 0.516704f, 
            0.676090f, 0.095618f, 0.075512f, 0.218587f, 0.100579f, 0.208679f, 0.587373f, 0.037468f, 
            0.122700f, 0.586855f, 0.079803f, 0.348755f, 0.087391f, 0.544201f, 0.154357f, 0.195805f, 
            0.740805f, 0.489011f, 0.171004f, 0.098661f, 0.695403f, 0.564536f, 0.744950f, 0.145165f, 
            0.638400f, 0.394755f, 0.251423f, 0.197920f, 0.448250f, 0.279957f, 0.066754f, 0.514423f, 
            0.298992f, 0.173771f, 0.390687f, 0.100924f, 0.181796f, 0.484352f, 0.293591f, 0.673578f, 
            0.139546f, 0.187736f, 0.109743f, 0.504062f, 0.261021f, 0.396566f, 0.161204f, 0.764612f, 
            0.429050f, 0.133188f, 0.853443f, 0.136822f, 0.613616f, 0.282029f, 0.454956f, 0.703271f, 
            0.077399f, 0.026637f, 0.535405f, 0.227761f, 0.165051f, 0.247727f, 0.145307f, 0.350772f
        };
        float upstream_grad_data_8[] = {
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f
        };
        float expected_grad_8[] = {
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, -0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            -0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, -0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f
        };

        Tensor t_softmax_output_8 = create_test_tensor(shape_8, softmax_output_data_8, false);
        Tensor t_upstream_grad_8 = create_test_tensor(shape_8, upstream_grad_data_8, false);
        Tensor t_expected_grad_8 = create_test_tensor(shape_8, expected_grad_8, false);
        Tensor t_softmax_8 = nn_softmax(t_softmax_output_8, dim_8);
        Tensor_backward(t_softmax_8, t_upstream_grad_8);
        compare_tensors(&t_softmax_8.node->grad, &t_expected_grad_8, op_name, tc_name, 1, TEST_FLOAT_TOLERANCE);
    }

	// Test Case 9
    {
		const char* tc_name = "softmax_backward_4d_dim_2";
		TensorShape shape_9 = { 2, 3, 4, 5 };
		int dim_9 = 2;
		float softmax_output_data_9[] = {
			0.291880f, 0.125233f, 0.182044f, 0.498073f, 0.404432f, 0.169677f, 0.511194f, 0.562892f, 
			0.223964f, 0.301325f, 0.283817f, 0.230031f, 0.109788f, 0.121532f, 0.102276f, 0.254626f, 
			0.133543f, 0.145276f, 0.156432f, 0.191967f, 0.602902f, 0.167705f, 0.505784f, 0.006449f, 
			0.153610f, 0.213243f, 0.144857f, 0.216105f, 0.271212f, 0.187101f, 0.057155f, 0.034944f, 
			0.202119f, 0.621340f, 0.582470f, 0.126700f, 0.652493f, 0.075992f, 0.100999f, 0.076819f, 
			0.025284f, 0.535498f, 0.321159f, 0.547032f, 0.042252f, 0.055964f, 0.051368f, 0.214569f, 
			0.171173f, 0.068723f, 0.155868f, 0.315531f, 0.373057f, 0.090525f, 0.074880f, 0.762884f, 
			0.097602f, 0.091214f, 0.191271f, 0.814145f, 0.364001f, 0.375110f, 0.335413f, 0.776141f, 
			0.336847f, 0.021910f, 0.342610f, 0.216313f, 0.024883f, 0.461198f, 0.331734f, 0.255358f, 
			0.047576f, 0.170723f, 0.174370f, 0.282355f, 0.026922f, 0.400698f, 0.028253f, 0.027585f, 
			0.126244f, 0.380872f, 0.172078f, 0.081861f, 0.299249f, 0.453514f, 0.559052f, 0.085891f, 
			0.174117f, 0.077363f, 0.349205f, 0.027823f, 0.148069f, 0.249145f, 0.076060f, 0.071037f, 
			0.032253f, 0.593962f, 0.494877f, 0.547328f, 0.372310f, 0.493528f, 0.478135f, 0.109682f, 
			0.117111f, 0.478561f, 0.015935f, 0.303751f, 0.041923f, 0.087090f, 0.030095f, 0.353678f, 
			0.081628f, 0.497504f, 0.069155f, 0.119034f, 0.136859f, 0.136486f, 0.350890f, 0.726643f
		};
		float upstream_grad_data_9[] = {
			1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
			1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
			1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f
	    };
        float expected_grad_9[] = {
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f
        };

        Tensor t_softmax_output_9 = create_test_tensor(shape_9, softmax_output_data_9, false);
        Tensor t_upstream_grad_9 = create_test_tensor(shape_9, upstream_grad_data_9, false);
        Tensor t_expected_grad_9 = create_test_tensor(shape_9, expected_grad_9, false);
        Tensor t_softmax_9 = nn_softmax(t_softmax_output_9, dim_9);
        Tensor_backward(t_softmax_9, t_upstream_grad_9);
        compare_tensors(&t_softmax_9.node->grad, &t_expected_grad_9, op_name, tc_name, 1, TEST_FLOAT_TOLERANCE);
    }

	// Test Case 10
	{
	    const char* tc_name = "softmax_backward_4d_dim_3";
	    TensorShape shape_10 = { 2, 3, 4, 5 };
	    int dim_10 = 3;
	    float softmax_output_data_10[] = {
			0.066401f, 0.158825f, 0.325174f, 0.193684f, 0.255916f, 0.211079f, 0.241442f, 0.225608f, 
			0.269596f, 0.052274f, 0.098790f, 0.040214f, 0.116746f, 0.541744f, 0.202506f, 0.135448f, 
            0.114021f, 0.116338f, 0.496727f, 0.137465f, 0.108314f, 0.121477f, 0.275101f, 0.061351f, 
            0.433757f, 0.047564f, 0.289791f, 0.223113f, 0.371671f, 0.067861f, 0.035685f, 0.048276f, 
            0.131985f, 0.378139f, 0.405915f, 0.070004f, 0.062254f, 0.583989f, 0.100436f, 0.183317f, 
            0.305591f, 0.033705f, 0.279647f, 0.223692f, 0.157365f, 0.109443f, 0.196573f, 0.185457f, 
            0.190898f, 0.317629f, 0.212507f, 0.346504f, 0.137915f, 0.219323f, 0.083751f, 0.187271f, 
            0.066957f, 0.069592f, 0.567064f, 0.109115f, 0.042001f, 0.062575f, 0.132275f, 0.720434f, 
            0.042715f, 0.376084f, 0.302346f, 0.042666f, 0.191719f, 0.087185f, 0.117984f, 0.152122f, 
            0.220522f, 0.292303f, 0.217070f, 0.194241f, 0.051929f, 0.007380f, 0.015124f, 0.731326f, 
            0.243276f, 0.393607f, 0.231850f, 0.077948f, 0.053319f, 0.202010f, 0.274588f, 0.056622f, 
            0.054226f, 0.412553f, 0.129608f, 0.203751f, 0.300948f, 0.043970f, 0.321724f, 0.038599f, 
            0.337018f, 0.276438f, 0.029686f, 0.318260f, 0.810219f, 0.025352f, 0.018812f, 0.045306f, 
            0.100312f, 0.231369f, 0.149545f, 0.032563f, 0.462638f, 0.123885f, 0.029724f, 0.117840f, 
            0.011977f, 0.047307f, 0.793153f, 0.020167f, 0.540207f, 0.078490f, 0.079111f, 0.282025f
        };
        float upstream_grad_data_10[] = {
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 
            1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f, 1.000000f
        };
        float expected_grad_10[] = {
            -0.000000f, -0.000000f, -0.000000f, -0.000000f, -0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, -0.000000f, -0.000000f, -0.000000f, -0.000000f, -0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 
            0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f, 0.000000f
        };
        Tensor t_softmax_output_10 = create_test_tensor(shape_10, softmax_output_data_10, false);
        Tensor t_upstream_grad_10 = create_test_tensor(shape_10, upstream_grad_data_10, false);
        Tensor t_expected_grad_10 = create_test_tensor(shape_10, expected_grad_10, false);
        Tensor t_softmax_10 = nn_softmax(t_softmax_output_10, dim_10);
        Tensor_backward(t_softmax_10, t_upstream_grad_10);
        compare_tensors(&t_softmax_10.node->grad, &t_expected_grad_10, op_name, tc_name, 1, TEST_FLOAT_TOLERANCE);
    }
    cten_free(pool_id);
}